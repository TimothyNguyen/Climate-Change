---
title: "R Notebook"
output: html_notebook
---

# **HW 3 - Presentation**

```{r}
install.packages("choroplethrMaps")
library(shiny)
library(ggplot2) 
library(plotly)
library(tidyr)
library(dplyr)
library(countrycode)
library(choroplethr)
```

```{r}
gdp_per_cap <- 
  read.csv(
    "./data/income_per_person_gdppercapita_ppp_inflation_adjusted.csv", 
    header = TRUE, 
    stringsAsFactors = FALSE,
    check.names = FALSE
    )
pop <-
  read.csv(
    "./data/population_total.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
coal_df <-
  read.csv(
    "./data/coal_consumption_total.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )

yearly_co2 <-
  read.csv(
    "./data/yearly_co2_emissions_1000_tonnes.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
wood_removal <-
  read.csv(
    "./data/wood_removal_cubic_meters.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
total_sulfur <-
  read.csv(
    "./data/total_sulfur_emission_kilotonnes.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
land_temp <-
  read.csv(
    "./data/GlobalLandTemperaturesByCountry.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
```

```{r}
gdp_per_cap$continent <- countrycode(sourcevar = gdp_per_cap[, "country"],
                            origin = "country.name",
                            destination = "continent")
pop$continent <- countrycode(sourcevar = pop[, "country"],
                            origin = "country.name",
                            destination = "continent")
coal_df$continent <- countrycode(sourcevar = coal_df[, "country"],
                            origin = "country.name",
                            destination = "continent")
```

yearly_co

```{r}
land_temp$continent <- countrycode(sourcevar = land_temp[, "country"],
                            origin = "country.name",
                            destination = "continent")
yearly_co2$continent <- countrycode(sourcevar = yearly_co2[, "country"],
                            origin = "country.name",
                            destination = "continent")
wood_removal$continent <- countrycode(sourcevar = wood_removal[, "country"],
                            origin = "country.name",
                            destination = "continent")
total_sulfur$continent <- countrycode(sourcevar = total_sulfur[, "country"],
                            origin = "country.name",
                            destination = "continent")
```

```{r}
library(readr)
land_temp <- land_temp %>% drop_na("continent")
drop <- c("AverageTemperatureUncertainty")
land_temp <- land_temp[!(names(land_temp) %in% drop)]
land_temp <- within(land_temp,
                    date <- ifelse(!is.na(as.Date(land_temp$dt, "%Y-%m-%d")),
                            as.character(as.Date(land_temp$dt, "%Y-%m-%d")),
                            as.character(as.Date(land_temp$dt, "%m/%d/%Y")))) 
land_temp <- land_temp[!(names(land_temp) %in% drop)]
land_temp <- na.omit(land_temp)
land_temp
```

```{r}
library(lubridate)
land_df <- land_temp %>%
  mutate(country, year = year(date)) %>%
  group_by(country, year, continent)
drop <- c("dt")
land_df <- land_df[!(names(land_df) %in% drop)]
land_df <- aggregate(land_df$AverageTemperature, 
                     by=list(year=land_df$year, 
                             country=land_df$country,
                             continent=land_df$continent), 
                              FUN=mean, na.action = na.omit)
land_df <- land_df %>%
  mutate(AverageTemperature = x * 1.8 + 32)
drop <- c("x")
land_df <- land_df[!(names(land_df) %in% drop)]
names(land_df)[4] <- "AverageTemperature"
land_df  
```

```{r}
df_co2 <- yearly_co2%>%
  pivot_longer(c('1850':'2012'), names_to = "year", 
               values_to = "co2_emissions") %>%
  select(country, year, co2_emissions)
df_co2 <- na.omit(df_co2, cols=c("co2_emissions"))
df_gdp <- gdp_per_cap%>%
  pivot_longer(c('1850':'2012'), names_to = "year", values_to = "gdpPercap") %>%
  select(country, year, gdpPercap)
df_pop <- pop%>%
  pivot_longer(c('1850':'2012'), names_to = "year", values_to = "pop") %>%
  select(country, year, pop)
df_land <- filter(land_df, year >= 1850) %>% filter(year <= 2012)
df_land <- df_land %>% mutate(year = as.character(year))
```

```{r}
first_graph <- left_join(df_pop, df_co2) %>%
               merge(df_land)
first_graph <- na.omit(first_graph, cols=c("co2_emissions"))
first_graph$CODE <- countrycode(first_graph$country, origin = 'country.name', destination = 'genc3c')
first_graph
```

```{r}

df_example <- first_graph %>%
  filter(year == 2000)
fig <- plot_ly(df_example, type='choropleth', 
               locations=df_example$CODE, 
               z=df_example$AverageTemperature, 
               text=df_example$country)
fig
```

```{r}
library(shiny)
con <- factor(c('Asia','Africa', 'Americas', 'Europe', 'Oceania'))
print(levels(con))
ui <- fluidPage(
    titlePanel("C02 vs Land Temperature"),
    
    sidebarLayout(
        sidebarPanel(
            helpText("Interavtive plotting of data usng R shiny"),
            
            sliderInput("year", "Year",
                        min = range(as.numeric( first_graph$year))[1],
                        max = range(as.numeric( first_graph$year))[2],
                        value = range(as.numeric( first_graph$year))[1],
                        sep = "",
                        step = 5,
                        animate = animationOptions(interval = 500)
            )
        ),
        
        mainPanel(plotOutput("gap"))
    )
)


server <- function(input, output) {
    
    output$gap <- renderPlot({ 
        df <- first_graph %>%
            filter(year == input$year) %>%
            rename(region = country, value = AverageTemperature) %>%
    mutate(region = tolower(region)) %>%
    mutate(region = recode(region,
                            "united states"    = "united states of america",
                          "congo, dem. rep." = "democratic republic of the congo",
                            "congo, rep."      = "republic of congo",
                            "korea, dem. rep." = "south korea",
                            "korea. rep."      = "north korea",
                            "tanzania"         = "united republic of tanzania",
                            "serbia"           = "republic of serbia",
                            "slovak republic"  = "slovakia",
                            "yemen, rep."      = "yemen"))
        country_choropleth(df) + scale_fill_brewer(palette="YlOrRd")
        
    })
}

shinyApp(ui = ui, server = server)
```

```{r}
library(shiny)
con <- factor(c('Asia','Africa', 'Americas', 'Europe', 'Oceania'))
print(levels(con))
ui <- fluidPage(
    titlePanel("C02 vs Land Temperature"),
    
    sidebarLayout(
        sidebarPanel(
            helpText("Interavtive plotting of data usng R shiny"),
            
            checkboxGroupInput("continent", 
                               "Choose a continent", 
                               choices = levels(con),
                               selected = levels(con)),
            
            sliderInput("quantiles", "CO2 Quantiles of interest",
                        min = 0,
                        max = 100,
                        value = c(0, 100),
                        sep = ""),
            
            sliderInput("year", "Year",
                        min = range(as.numeric(first_graph$year))[1],
                        max = range(as.numeric(first_graph$year))[2],
                        value = range(as.numeric(first_graph$year))[1],
                        sep = "",
                        step = 5,
                        animate = animationOptions(interval = 500)
            )
        ),
        
        mainPanel(plotOutput("gap"))
    )
)

max_x <- max(first_graph$co2_emissions)
min_x <- min(first_graph$co2_emissions)
max_y <- max(first_graph$AverageTemperature)
min_y <- min(first_graph$AverageTemperature)
print(min_x)
print(max_x)
print(min_y)
print(max_y)

server <- function(input, output) {
    
    output$gap <- renderPlot({ 
        df <- first_graph %>%
            filter(year == input$year) %>%
            filter(continent %in% input$continent)
             
            filter(df, co2_emissions <= quantile(df$co2_emissions, 
                                         probs = (max(input$quantiles)/100),
                                        na.rm = TRUE)) %>%
            filter(co2_emissions >= quantile(df$co2_emissions, 
                                         probs = (min(input$quantiles)/100),
                                   na.rm = TRUE)) %>%
            ggplot(aes(x = co2_emissions, 
                       y = AverageTemperature, color=continent)) +
            geom_point(aes(size = pop, frame = year, ids = country)) + 
            scale_x_log10(limits = c(min_x + 0.1, max_x)) + 
            ylim(min_y, max_y) + 
            theme(legend.title = element_blank())
    })
}

shinyApp(ui = ui, server = server)
```

```{r}
start_year <- 1965
end_year <- 2019
df <- reshape(gdp_per_cap,
              direction="long",
              varying = list(names(gdp_per_cap)
                             [(start_year - 1800 + 2): (end_year - 1800 + 2)]),
              v.names = "gdpPercap",
              idvar = c("country"),
              timevar = "year",
              times = start_year:end_year)
df_2 <- reshape(coal_df,
              direction="long",
              varying = list(names(coal_df)
                             [2: (end_year - start_year + 2)]),
              v.names = "coal",
              idvar = c("country"),
              timevar = "year",
            times = start_year:end_year)
df_3 <- reshape(pop,
              direction="long",
              varying = list(names(pop)
                             [(start_year - 1800 + 2): (end_year - 1800 + 2)]),
              v.names = "pop",
              idvar = c("country"),
              timevar = "year",
              times = start_year:end_year)
```

```{r}
keeps_pop <- c("country", "continent", "year", "pop")
keeps_coal <- c("country", "continent", "year", "coal")
keeps_gdp <- c("country", "continent", "year", "gdpPercap")
df_3 <- df_3[keeps_pop]
df_2 <- df_2[keeps_coal]
df <- df[keeps_gdp]
merge_df <- merge(df, df_3) %>% merge(df_2)
head(merge_df)
```

```{r}
# Remove any unnecessary data
remove(df)
remove(df_2)
remove(df_3)
```

```{r}
gg <- ggplot(merge_df, aes(coal, gdpPercap, color = continent)) +
  geom_point(aes(size = pop, frame = year, ids = country)) +
  scale_x_log10() + 
  scale_y_log10() +
  theme(legend.title = element_blank())
ggplotly(gg)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
