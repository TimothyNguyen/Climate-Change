---
title: "R Notebook"
output: html_notebook
---

# **HW 3 - Presentation**

```{r}
# install.packages("choroplethrMaps")
library(shiny)
library(ggplot2) 
library(plotly)
library(tidyr)
library(dplyr)
library(countrycode)
library(choroplethr)
library(readr)
library(lubridate)
library(gridExtra)
```

**Part I: Data Cleaning:**

Here we're looking to load our data and clean it around a bit

```{r}
gdp_per_cap <- 
  read.csv(
    "./data/income_per_person_gdppercapita_ppp_inflation_adjusted.csv", 
    header = TRUE, 
    stringsAsFactors = FALSE,
    check.names = FALSE
    )
pop <-
  read.csv(
    "./data/population_total.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
coal_df <-
  read.csv(
    "./data/coal_consumption_total.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )

yearly_co2 <-
  read.csv(
    "./data/yearly_co2_emissions_1000_tonnes.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
wood_removal <-
  read.csv(
    "./data/wood_removal_cubic_meters.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
total_sulfur <-
  read.csv(
    "./data/total_sulfur_emission_kilotonnes.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
land_temp <-
  read.csv(
    "./data/GlobalLandTemperaturesByCountry.csv",
    header = TRUE,
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
```

```{r}
gdp_per_cap$continent <- countrycode(sourcevar = gdp_per_cap[, "country"],
                            origin = "country.name",
                            destination = "continent")
pop$continent <- countrycode(sourcevar = pop[, "country"],
                            origin = "country.name",
                            destination = "continent")
coal_df$continent <- countrycode(sourcevar = coal_df[, "country"],
                            origin = "country.name",
                            destination = "continent")
land_temp$continent <- countrycode(sourcevar = land_temp[, "country"],
                            origin = "country.name",
                            destination = "continent")
yearly_co2$continent <- countrycode(sourcevar = yearly_co2[, "country"],
                            origin = "country.name",
                            destination = "continent")
wood_removal$continent <- countrycode(sourcevar = wood_removal[, "country"],
                            origin = "country.name",
                            destination = "continent")
total_sulfur$continent <- countrycode(sourcevar = total_sulfur[, "country"],
                            origin = "country.name",
                            destination = "continent")
```

```{r}
land_temp <- land_temp %>% drop_na("continent")
drop <- c("AverageTemperatureUncertainty")
land_temp <- land_temp[!(names(land_temp) %in% drop)]
land_temp <- within(land_temp,
                    date <- ifelse(!is.na(as.Date(land_temp$dt, "%Y-%m-%d")),
                            as.character(as.Date(land_temp$dt, "%Y-%m-%d")),
                            as.character(as.Date(land_temp$dt, "%m/%d/%Y")))) 
land_temp <- land_temp[!(names(land_temp) %in% drop)]
land_temp <- na.omit(land_temp)
```

```{r}

land_df <- land_temp %>%
  mutate(country, year = year(date)) %>%
  group_by(country, year, continent)
drop <- c("dt")
land_df <- land_df[!(names(land_df) %in% drop)]
land_df <- aggregate(land_df$AverageTemperature, 
                     by=list(year=land_df$year, 
                             country=land_df$country,
                             continent=land_df$continent), 
                              FUN=mean, na.action = na.omit)
land_df <- land_df %>%
  mutate(AverageTemperature = x * 1.8 + 32)
drop <- c("x")
land_df <- land_df[!(names(land_df) %in% drop)]
names(land_df)[4] <- "AverageTemperature"
land_df  
```

```{r}
df_co2 <- yearly_co2%>%
  pivot_longer(c('1900':'2012'), names_to = "year", 
               values_to = "co2_emissions") %>%
  select(country, year, co2_emissions)
df_co2 <- na.omit(df_co2, cols=c("co2_emissions"))
df_gdp <- gdp_per_cap%>%
  pivot_longer(c('1900':'2012'), names_to = "year", values_to = "gdpPercap") %>%
  select(country, year, gdpPercap)
df_pop <- pop%>%
  pivot_longer(c('1900':'2012'), names_to = "year", values_to = "pop") %>%
  select(country, year, pop)
df_land <- filter(land_df, year >= 1900) %>% filter(year <= 2012)
df_land <- df_land %>% mutate(year = as.character(year))
```

```{r}
first_graph <- left_join(df_pop, df_co2) %>%
               merge(df_land)
first_graph <- na.omit(first_graph, cols=c("co2_emissions"))
first_graph$CODE <- countrycode(first_graph$country, origin = 'country.name', destination = 'genc3c')
first_graph
```

**Part II: Choropleth World Maps: Rising Temperatures & Carbon Dioxide**

Here we create our first shiny application. Through choropleth world maps, we wanted to visualize the land temperature of individual countries and looking at them for every year. While there is lots of missing data from countries in the beginning, the overall trend is that temperatures are rising as years increase.

```{r}
library(shiny)
con <- factor(c('Asia','Africa', 'Americas', 'Europe', 'Oceania'))
print(levels(con))
ui <- fluidPage(
    
    sidebarLayout(
        sidebarPanel(
            helpText("Interactive plotting on Land Temperatures"),
            
            sliderInput("year", "Year (Land Temperatures)",
                        min = range(as.numeric( first_graph$year))[1],
                        max = range(as.numeric( first_graph$year))[2],
                        value = range(as.numeric( first_graph$year))[1],
                        sep = "",
                        step = 1,
                        animate = animationOptions(interval = 500)
            ),
            helpText("Interactive plotting on CO2 Emissions"),
            
            sliderInput("year2", "Year",
                        min =  range(as.numeric( first_graph$year))[1],
                        max = range(as.numeric( first_graph$year))[2],
                        value = range(as.numeric( first_graph$year))[1],
                        sep = "",
                        step = 1,
                        animate = animationOptions(interval = 500)
            )
        ),

        mainPanel(plotOutput("gap"))
    ),
)


server <- function(input, output) {
    
    output$gap <- renderPlot({ 
        df <- first_graph %>%
            filter(year == input$year) %>%
            rename(region = country, value = AverageTemperature) %>%
    mutate(region = tolower(region)) %>%
    mutate(region = recode(region,
                            "united states"    = "united states of america",
                          "congo, dem. rep." = "democratic republic of the congo",
                            "congo, rep."      = "republic of congo",
                            "korea, dem. rep." = "south korea",
                            "korea. rep."      = "north korea",
                            "tanzania"         = "united republic of tanzania",
                            "serbia"           = "republic of serbia",
                            "slovak republic"  = "slovakia",
                            "yemen, rep."      = "yemen"))
        p1 <- country_choropleth(df, num_colors=5) + 
                            scale_fill_brewer(palette="OrRd")
        
        df2 <- first_graph %>%
            filter(year == input$year2) %>%
            rename(region = country, value = co2_emissions) %>%
    mutate(region = tolower(region)) %>%
    mutate(region = recode(region,
                            "united states"    = "united states of america",
                          "congo, dem. rep." = "democratic republic of the congo",
                            "congo, rep."      = "republic of congo",
                            "korea, dem. rep." = "south korea",
                            "korea. rep."      = "north korea",
                            "tanzania"         = "united republic of tanzania",
                            "serbia"           = "republic of serbia",
                            "slovak republic"  = "slovakia",
                            "yemen, rep."      = "yemen"))
        p2 <- country_choropleth(df2, num_colors=5) + 
                            scale_fill_brewer(palette="OrRd")
        
        grid.arrange(p1, arrangeGrob(p2), nrow = 2)
        
    })
}

shinyApp(ui = ui, server = server)
```

**Part III: Scatterplotting data between variables (CO2 vs Avg Land Temperatures)**

So after measuring the choropleths of CO2 emissions and average land temperatures, we notice that they were both increasing over time. We then wanted to investigate with an interactive scatterplot between CO2 emissions per tonnes vs average land temperatures in Fahrenheit.

```{r}
library(shiny)
con <- factor(c('Asia','Africa', 'Americas', 'Europe', 'Oceania'))
print(levels(con))
ui <- fluidPage(
    titlePanel("C02 vs Land Temperature"),
    
    sidebarLayout(
        sidebarPanel(
            helpText("Interavtive plotting of data usng R shiny"),
            
            checkboxGroupInput("continent", 
                               "Choose a continent", 
                               choices = levels(con),
                               selected = levels(con)),
            
            sliderInput("quantiles", "CO2 Quantiles of interest",
                        min = 0,
                        max = 100,
                        value = c(0, 100),
                        sep = ""),
            
            sliderInput("year", "Year",
                        min = range(as.numeric(first_graph$year))[1],
                        max = range(as.numeric(first_graph$year))[2],
                        value = range(as.numeric(first_graph$year))[1],
                        sep = "",
                        step = 5,
                        animate = animationOptions(interval = 500)
            )
        ),
        
        mainPanel(plotOutput("gap"))
    )
)

max_x <- max(first_graph$co2_emissions)
min_x <- min(first_graph$co2_emissions)
max_y <- max(first_graph$AverageTemperature)
min_y <- min(first_graph$AverageTemperature)

server <- function(input, output) {
    
    output$gap <- renderPlot({ 
        df <- first_graph %>%
            filter(year == input$year) %>%
            filter(continent %in% input$continent)
             
            filter(df, co2_emissions <= quantile(df$co2_emissions, 
                                         probs = (max(input$quantiles)/100),
                                        na.rm = TRUE)) %>%
            filter(co2_emissions >= quantile(df$co2_emissions, 
                                         probs = (min(input$quantiles)/100),
                                   na.rm = TRUE)) %>%
            ggplot(aes(x = co2_emissions, 
                       y = AverageTemperature, color=continent)) +
            geom_point(aes(size = pop, frame = year, ids = country)) + 
            scale_x_log10(limits = c(min_x + 0.1, max_x)) + 
            ylim(min_y, max_y) + 
            theme(legend.title = element_blank())
    })
}

shinyApp(ui = ui, server = server)
```
